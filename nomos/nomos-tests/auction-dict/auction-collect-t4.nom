proc transaction collect_frank : . |{*}- ($d : 1) =
{
  #a : auction <- Nomos.MakeChannel 3 ;
  $la <- acquire #a ;
  pay $la {*} ;
  case $la (
    running => abort
  | ended => case $la (
      won => $l <- recv $la ;
             get $la {*} ;
             #a <- release $la ;
             wait $l ;
             deposit {*} ;
             close $d
    | lost => $m <- recv $la ;
              get $la {*} ;
              #a <- release $la ;
              pay $m {*} ;
              $m.destroy ;
              get $m {*} ;
              wait $m ;
              deposit {*} ;
              close $d
    )
  )
}

exec collect_frank